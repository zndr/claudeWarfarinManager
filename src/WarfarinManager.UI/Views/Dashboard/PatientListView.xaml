<UserControl
    x:Class="WarfarinManager.UI.Views.Dashboard.PatientListView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:WarfarinManager.UI.ViewModels"
    d:DataContext="{d:DesignInstance Type=vm:PatientListViewModel}"
    d:DesignHeight="600"
    d:DesignWidth="1000"
    mc:Ignorable="d">

    <!--  Resources  -->
    <UserControl.Resources>
        <!--  Converter BoolToVisibility  -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Header con titolo e statistiche  -->
        <Border
            Grid.Row="0"
            Padding="20,15"
            Background="{DynamicResource PrimaryBrush}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock
                        FontSize="20"
                        FontWeight="SemiBold"
                        Foreground="{DynamicResource TextOnPrimaryBrush}"
                        Text="Gestione Pazienti" />
                    <TextBlock
                        Margin="0,4,0,0"
                        FontSize="12"
                        Foreground="{DynamicResource TextOnPrimaryBrush}"
                        Opacity="0.9">
                        <Run Text="Pazienti totali:" />
                        <Run FontWeight="SemiBold" Text="{Binding TotalPatientsCount, Mode=OneWay}" />
                        <Run Text=" | Visualizzati:" />
                        <Run FontWeight="SemiBold" Text="{Binding FilteredPatientsCount, Mode=OneWay}" />
                    </TextBlock>
                </StackPanel>

                <StackPanel
                    Grid.Column="1"
                    VerticalAlignment="Center"
                    Orientation="Horizontal">
                    <Button
                        Margin="0,0,10,0"
                        Padding="15,8"
                        Background="{DynamicResource WarningBrush}"
                        BorderThickness="0"
                        Command="{Binding AddNewPatientCommand}"
                        Content="➕ Nuovo Paziente"
                        Cursor="Hand"
                        FontWeight="SemiBold"
                        Foreground="{DynamicResource TextOnPrimaryBrush}">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border
                                                Padding="{TemplateBinding Padding}"
                                                Background="{TemplateBinding Background}"
                                                CornerRadius="4">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource WarningHoverBrush}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <Button
                        Padding="15,8"
                        Background="{DynamicResource CardBackgroundBrush}"
                        BorderThickness="0"
                        Command="{Binding RefreshCommand}"
                        Content="🔄 Aggiorna"
                        Cursor="Hand"
                        FontWeight="SemiBold"
                        Foreground="{DynamicResource PrimaryBrush}">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border
                                                Padding="{TemplateBinding Padding}"
                                                Background="{TemplateBinding Background}"
                                                CornerRadius="4">
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!--  Barra ricerca  -->
        <Border
            Grid.Row="1"
            Padding="20,15"
            Background="{DynamicResource ToolbarBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,10,0"
                        VerticalAlignment="Center"
                        FontSize="18"
                        Text="🔍" />
                    <TextBox
                        x:Name="SearchTextBox"
                        Width="400"
                        Padding="8"
                        VerticalContentAlignment="Center"
                        BorderBrush="{DynamicResource ControlBorderBrush}"
                        BorderThickness="1"
                        FontSize="13"
                        Background="{DynamicResource ControlBackgroundBrush}"
                        Foreground="{DynamicResource TextPrimaryBrush}"
                        Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}">
                        <TextBox.Resources>
                            <Style TargetType="TextBox">
                                <Style.Triggers>
                                    <Trigger Property="Text" Value="">
                                        <Setter Property="Background">
                                            <Setter.Value>
                                                <VisualBrush AlignmentX="Left" Stretch="None">
                                                    <VisualBrush.Visual>
                                                        <TextBlock
                                                            Margin="5,0"
                                                            Foreground="{DynamicResource TextTertiaryBrush}"
                                                            Text="Cerca per nome, cognome o codice fiscale..." />
                                                    </VisualBrush.Visual>
                                                </VisualBrush>
                                            </Setter.Value>
                                        </Setter>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Resources>
                    </TextBox>
                </StackPanel>
            </Grid>
        </Border>

        <!--  DataGrid Pazienti  -->
        <DataGrid
            Grid.Row="2"
            AlternatingRowBackground="{DynamicResource DataGridAlternateRowBrush}"
            AutoGenerateColumns="False"
            CanUserResizeRows="False"
            CanUserSortColumns="True"
            FontSize="13"
            GridLinesVisibility="Horizontal"
            HeadersVisibility="Column"
            IsReadOnly="True"
            ItemsSource="{Binding FilteredPatients}"
            MouseDoubleClick="DataGrid_MouseDoubleClick"
            RowHeight="40"
            SelectedItem="{Binding SelectedPatient}"
            SelectionMode="Single"
            Background="{DynamicResource CardBackgroundBrush}"
            Foreground="{DynamicResource TextPrimaryBrush}"
            BorderBrush="{DynamicResource BorderBrush}">

            <DataGrid.ColumnHeaderStyle>
                <Style TargetType="DataGridColumnHeader">
                    <Setter Property="Background" Value="{DynamicResource DataGridHeaderBrush}" />
                    <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
                    <Setter Property="FontWeight" Value="SemiBold" />
                    <Setter Property="Padding" Value="12,10" />
                    <Setter Property="BorderThickness" Value="0,0,1,1" />
                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
                    <Setter Property="HorizontalContentAlignment" Value="Left" />
                </Style>
            </DataGrid.ColumnHeaderStyle>

            <DataGrid.CellStyle>
                <Style TargetType="DataGridCell">
                    <Setter Property="Padding" Value="12,0" />
                    <Setter Property="BorderThickness" Value="0" />
                    <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="DataGridCell">
                                <Border Padding="{TemplateBinding Padding}" Background="{TemplateBinding Background}">
                                    <ContentPresenter VerticalAlignment="Center" TextElement.Foreground="{TemplateBinding Foreground}" />
                                </Border>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="{DynamicResource DataGridSelectedBrush}" />
                            <Setter Property="Foreground" Value="{DynamicResource DataGridSelectedTextBrush}" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.CellStyle>

            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow">
                    <Setter Property="Background" Value="{DynamicResource DataGridRowBrush}" />
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="{DynamicResource DataGridHoverBrush}" />
                        </Trigger>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="{DynamicResource DataGridSelectedBrush}" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </DataGrid.RowStyle>

            <DataGrid.Columns>
                <!--  Cognome  -->
                <DataGridTextColumn
                    Width="100"
                    Binding="{Binding LastName}"
                    Header="Cognome" />

                <!--  Nome  -->
                <DataGridTextColumn
                    Width="100"
                    Binding="{Binding FirstName}"
                    Header="Nome" />

                <!--  Età  -->
                <DataGridTextColumn
                    Width="60"
                    Binding="{Binding Age}"
                    Header="Età" />

                <!--  Codice Fiscale  -->
                <DataGridTextColumn
                    Width="150"
                    Binding="{Binding FiscalCode}"
                    Header="Codice Fiscale" />

                <!--  Indicazione Attiva  -->
                <DataGridTextColumn
                    Width="180"
                    Binding="{Binding ActiveIndication}"
                    Header="Indicazione">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ActiveIndication}" Value="{x:Null}">
                                    <Setter Property="Text" Value="-" />
                                    <Setter Property="Foreground" Value="{DynamicResource TextTertiaryBrush}" />
                                    <Setter Property="FontStyle" Value="Italic" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!--  Ultimo INR  -->
                <DataGridTextColumn Width="60" Header="Ultimo&#10;INR">
                    <DataGridTextColumn.Binding>
                        <Binding Path="LastINR" StringFormat="{}{0:F2}" />
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding LastINR}" Value="{x:Null}">
                                    <Setter Property="Text" Value="-" />
                                    <Setter Property="Foreground" Value="{DynamicResource TextTertiaryBrush}" />
                                    <Setter Property="FontStyle" Value="Italic" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!--  Dose settimanale (mg/wk)  -->
                <DataGridTextColumn Width="70" Header="mg/wk">
                    <DataGridTextColumn.Binding>
                        <Binding Path="CurrentWeeklyDose" StringFormat="{}{0:F1}" />
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right" />
                            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding CurrentWeeklyDose}" Value="{x:Null}">
                                    <Setter Property="Text" Value="-" />
                                    <Setter Property="Foreground" Value="{DynamicResource TextTertiaryBrush}" />
                                    <Setter Property="FontStyle" Value="Italic" />
                                    <Setter Property="HorizontalAlignment" Value="Center" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!--  TTR %  -->
                <DataGridTextColumn Width="80" Header="TTR %">
                    <DataGridTextColumn.Binding>
                        <Binding Path="TTRPercentage" StringFormat="{}{0:F1}%" />
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Center" />
                            <Setter Property="FontWeight" Value="SemiBold" />
                            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding TTRPercentage}" Value="{x:Null}">
                                    <Setter Property="Text" Value="-" />
                                    <Setter Property="Foreground" Value="{DynamicResource TextTertiaryBrush}" />
                                    <Setter Property="FontStyle" Value="Italic" />
                                    <Setter Property="FontWeight" Value="Normal" />
                                </DataTrigger>
                                <!--  TTR >= 70% Verde  -->
                                <DataTrigger Binding="{Binding IsTTRCritical}" Value="False">
                                    <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}" />
                                </DataTrigger>
                                <!--  TTR < 60% Rosso  -->
                                <DataTrigger Binding="{Binding IsTTRCritical}" Value="True">
                                    <Setter Property="Foreground" Value="{DynamicResource DangerBrush}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <!--  Azioni  -->
                <DataGridTemplateColumn Width="220" Header="Azioni">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <!-- Bottone Visualizza Dettagli -->
                                <Button
                                    Padding="6,3"
                                    Margin="0,0,4,0"
                                    Background="{DynamicResource PrimaryBrush}"
                                    BorderThickness="0"
                                    Command="{Binding DataContext.OpenPatientDetailsCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                    Content="Vedi"
                                    Cursor="Hand"
                                    FontSize="10"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource TextOnPrimaryBrush}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border
                                                            Padding="{TemplateBinding Padding}"
                                                            Background="{TemplateBinding Background}"
                                                            CornerRadius="3">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="{DynamicResource PrimaryPressedBrush}" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <!-- Bottone Riassunto -->
                                <Button
                                    Padding="6,3"
                                    Margin="0,0,4,0"
                                    Background="{DynamicResource SuccessBrush}"
                                    BorderThickness="0"
                                    Command="{Binding DataContext.OpenPatientSummaryCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                    Content="Riassunto"
                                    Cursor="Hand"
                                    FontSize="10"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource TextOnPrimaryBrush}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border
                                                            Padding="{TemplateBinding Padding}"
                                                            Background="{TemplateBinding Background}"
                                                            CornerRadius="3">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="{DynamicResource SuccessHoverBrush}" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <!-- Bottone Elimina -->
                                <Button
                                    Padding="6,3"
                                    Background="{DynamicResource DangerBrush}"
                                    BorderThickness="0"
                                    Command="{Binding DataContext.DeletePatientCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                    Content="Elimina"
                                    Cursor="Hand"
                                    FontSize="10"
                                    FontWeight="SemiBold"
                                    Foreground="{DynamicResource TextOnPrimaryBrush}"
                                    ToolTip="Elimina o archivia il paziente">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border
                                                            Padding="{TemplateBinding Padding}"
                                                            Background="{TemplateBinding Background}"
                                                            CornerRadius="3">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="{DynamicResource DangerHoverBrush}" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <!--  Loading Overlay  -->
        <Grid
            Grid.Row="2"
            Background="#80FFFFFF"
            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock
                    HorizontalAlignment="Center"
                    FontSize="16"
                    FontWeight="SemiBold"
                    Foreground="{DynamicResource PrimaryBrush}"
                    Text="⏳ Caricamento pazienti in corso..." />
            </StackPanel>
        </Grid>

        <!--  Status Bar  -->
        <Border
            Grid.Row="3"
            Padding="15,8"
            Background="{DynamicResource StatusBarBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="0,1,0,0">
            <TextBlock FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}">
                <Run Text="Doppio click su una riga per aprire i dettagli del paziente" />
            </TextBlock>
        </Border>
    </Grid>
</UserControl>
