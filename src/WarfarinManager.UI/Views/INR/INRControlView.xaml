<Window
    x:Class="WarfarinManager.UI.Views.INR.INRControlView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:charts="clr-namespace:WarfarinManager.UI.Views.Charts"
    xmlns:converters="clr-namespace:WarfarinManager.UI.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:WarfarinManager.UI.ViewModels"
    Title="Controllo INR - Warfarin Manager Pro"
    Width="1400"
    Height="950"
    Background="#F5F5F5"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">

    <Window.Resources>
        <!--  Converter per Visibility  -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:BooleanAndToVisibilityConverter x:Key="BooleanAndToVisibilityConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:BoolToThicknessConverter x:Key="BoolToThicknessConverter" />
        <converters:DecimalConverter x:Key="DecimalConverter" />
        <converters:EnumToBoolConverter x:Key="EnumToBoolConverter" />
        <converters:BleedingTypeToStringConverter x:Key="BleedingTypeToStringConverter" />
        <converters:BleedingSiteToStringConverter x:Key="BleedingSiteToStringConverter" />
        
        <!--  Stili comuni  -->
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="#0078D4" />
            <Setter Property="Margin" Value="0,0,0,10" />
        </Style>

        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="White" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="20" />
            <Setter Property="Margin" Value="0,0,0,15" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect
                        BlurRadius="10"
                        Opacity="0.1"
                        ShadowDepth="2"
                        Color="#000000" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="InputLabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="#666666" />
            <Setter Property="Margin" Value="0,0,0,5" />
        </Style>

        <Style x:Key="InputTextBoxStyle" TargetType="TextBox">
            <Setter Property="Padding" Value="8" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="BorderBrush" Value="#CCCCCC" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style x:Key="DoseComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="BorderBrush" Value="#CCCCCC" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="MinWidth" Value="160" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
        </Style>

        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#0078D4" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Padding" Value="15,8" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}"
                            CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#106EBE" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#005A9E" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style
            x:Key="SecondaryButtonStyle"
            BasedOn="{StaticResource PrimaryButtonStyle}"
            TargetType="Button">
            <Setter Property="Background" Value="#FFFFFF" />
            <Setter Property="Foreground" Value="#0078D4" />
            <Setter Property="BorderBrush" Value="#0078D4" />
            <Setter Property="BorderThickness" Value="1" />
        </Style>

        <Style
            x:Key="SuccessButtonStyle"
            BasedOn="{StaticResource PrimaryButtonStyle}"
            TargetType="Button">
            <Setter Property="Background" Value="#107C10" />
        </Style>

        <Style
            x:Key="DangerButtonStyle"
            BasedOn="{StaticResource PrimaryButtonStyle}"
            TargetType="Button">
            <Setter Property="Background" Value="#D13438" />
        </Style>

        <Style
            x:Key="SmallButtonStyle"
            BasedOn="{StaticResource SecondaryButtonStyle}"
            TargetType="Button">
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="FontSize" Value="12" />
        </Style>
    </Window.Resources>

    <Grid>
        <!--  Header  -->
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Header Paziente  -->
        <Border
            Grid.Row="0"
            Padding="20"
            Background="#0078D4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!--  Pulsante Indietro  -->
                <Button
                    Grid.Column="0"
                    Margin="0,0,20,0"
                    Padding="12,8"
                    VerticalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="0"
                    Command="{Binding GoBackCommand}"
                    Cursor="Hand"
                    ToolTip="Torna all'elenco pazienti">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock
                            FontSize="18"
                            Foreground="White"
                            Text="â†" />
                        <TextBlock
                            Margin="8,0,0,0"
                            FontSize="14"
                            Foreground="White"
                            Text="Indietro" />
                    </StackPanel>
                </Button>

                <StackPanel Grid.Column="1">
                    <TextBlock
                        FontSize="24"
                        FontWeight="Bold"
                        Foreground="White"
                        Text="{Binding PatientName}" />
                    <StackPanel Margin="0,5,0,0" Orientation="Horizontal">
                        <TextBlock
                            FontSize="14"
                            Foreground="#CCCCCC"
                            Text="CF: " />
                        <TextBlock
                            FontSize="14"
                            FontWeight="SemiBold"
                            Foreground="White"
                            Text="{Binding PatientFiscalCode}" />
                        <TextBlock
                            Margin="10,0"
                            Foreground="#CCCCCC"
                            Text=" | " />
                        <TextBlock
                            FontSize="14"
                            Foreground="White"
                            Text="{Binding ActiveIndication}" />
                        <TextBlock
                            Margin="10,0,0,0"
                            Foreground="#CCCCCC"
                            Text=" | Target INR: " />
                        <TextBlock
                            FontSize="14"
                            FontWeight="SemiBold"
                            Foreground="White">
                            <Run Text="{Binding TargetINRMin, StringFormat=F1}" />
                            <Run Text="-" />
                            <Run Text="{Binding TargetINRMax, StringFormat=F1}" />
                        </TextBlock>
                    </StackPanel>
                </StackPanel>

                <!--  TTR Badge  -->
                <Border
                    Grid.Column="2"
                    Padding="15,8"
                    VerticalAlignment="Center"
                    Background="White"
                    CornerRadius="20">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock
                            FontSize="14"
                            Foreground="#666666"
                            Text="TTR: " />
                        <TextBlock
                            FontSize="16"
                            FontWeight="Bold"
                            Foreground="#0078D4"
                            Text="{Binding CurrentTTR, StringFormat=F1}" />
                        <TextBlock
                            FontSize="14"
                            Foreground="#666666"
                            Text="%" />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!--  Contenuto Principale  -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <Grid Margin="20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="20" />
                    <ColumnDefinition Width="3*" />
                </Grid.ColumnDefinitions>

                <!--  COLONNA SINISTRA: Form Inserimento  -->
                <StackPanel Grid.Column="0">

                    <!--  Form Controllo INR  -->
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Style="{StaticResource SectionHeaderStyle}" Text="ðŸ“Š NUOVO CONTROLLO INR" />

                            <!--  Data prelievo  -->
                            <TextBlock Style="{StaticResource InputLabelStyle}" Text="Data prelievo" />
                            <DatePicker
                                Margin="0,0,0,15"
                                FontSize="14"
                                SelectedDate="{Binding ControlDate}" />

                            <!--  Valore INR  -->
                            <TextBlock Style="{StaticResource InputLabelStyle}" Text="Valore INR" />
                            <TextBox
                                x:Name="InrValueTextBox"
                                Margin="0,0,0,5"
                                Style="{StaticResource InputTextBoxStyle}"
                                Text="{Binding InrValue, Converter={StaticResource DecimalConverter}, UpdateSourceTrigger=LostFocus}" />
                            <TextBlock
                                Margin="0,0,0,15"
                                FontSize="10"
                                Foreground="#999999"
                                Text="(Range valido: 0.5 - 15.0)" />

                            <!--  Fase terapia  -->
                            <TextBlock Style="{StaticResource InputLabelStyle}" Text="Fase terapia" />
                            <ComboBox
                                Margin="0,0,0,15"
                                Padding="8"
                                FontSize="14"
                                ItemsSource="{Binding TherapyPhases}"
                                SelectedItem="{Binding SelectedPhase}" />

                            <!--  Compliance  -->
                            <CheckBox
                                Margin="0,0,0,15"
                                Content="Paziente assume regolarmente la terapia"
                                FontSize="13"
                                IsChecked="{Binding IsCompliant}" />

                            <!--  Presenza Emorragia (abilitato solo per INR > 3.2)  -->
                            <TextBlock Style="{StaticResource InputLabelStyle}">
                                <Run Text="Presenza di sanguinamento" />
                                <Run FontSize="10" Foreground="#999999" Text="(solo per INR > 3.2)" />
                            </TextBlock>
                            <ComboBox
                                Margin="0,0,0,10"
                                Padding="8"
                                FontSize="14"
                                IsEnabled="{Binding CanSelectBleeding}"
                                ItemsSource="{Binding BleedingTypes}"
                                SelectedItem="{Binding SelectedBleedingType}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource BleedingTypeToStringConverter}}" />
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <!--  Sede Emorragia (visibile solo se c'Ã¨ emorragia)  -->
                            <StackPanel Visibility="{Binding HasBleeding, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Style="{StaticResource InputLabelStyle}" Text="Sede anatomica emorragia" />
                                <ComboBox
                                    Margin="0,0,0,15"
                                    Padding="8"
                                    FontSize="14"
                                    ItemsSource="{Binding BleedingSites}"
                                    SelectedItem="{Binding SelectedBleedingSite}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource BleedingSiteToStringConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <!--  Note  -->
                            <TextBlock Style="{StaticResource InputLabelStyle}" Text="Note cliniche" />
                            <TextBox
                                Height="80"
                                Padding="8"
                                AcceptsReturn="True"
                                BorderBrush="#CCCCCC"
                                BorderThickness="1"
                                FontSize="13"
                                Text="{Binding Notes}"
                                TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>

                    <!--  Dosaggio Settimanale Corrente  -->
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Style="{StaticResource SectionHeaderStyle}" Text="ðŸ’Š DOSAGGIO CORRENTE" />

                            <!--  CheckBox per escludere quarti di compressa  -->
                            <Border
                                Margin="0,0,0,15"
                                Padding="10"
                                Background="#FFF8E1"
                                BorderBrush="#FFB900"
                                BorderThickness="1"
                                CornerRadius="4">
                                <CheckBox
                                    Content="Escludi quarti di compressa (usa solo Â½ cp)"
                                    FontSize="12"
                                    FontWeight="SemiBold"
                                    Foreground="#5D4037"
                                    IsChecked="{Binding ExcludeQuarterTablets}"
                                    ToolTip="âœ“ Marcato: step 2.5 mg (Â½, 1, 1Â½, 2 cp...)&#x0a;â˜ Vuoto: step 1.25 mg (Â¼, Â½, Â¾, 1 cp...)" />
                            </Border>

                            <!--  Intestazione colonne  -->
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock
                                    Grid.Column="0"
                                    FontSize="11"
                                    FontWeight="SemiBold"
                                    Foreground="#999999"
                                    Text="GIORNO" />
                                <TextBlock
                                    Grid.Column="1"
                                    FontSize="11"
                                    FontWeight="SemiBold"
                                    Foreground="#999999"
                                    Text="DOSE (mg e compresse)" />
                            </Grid>

                            <!--  Griglia dosi giornaliere con ComboBox  -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="15" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!--  LunedÃ¬  -->
                                <TextBlock Grid.Row="0" Grid.Column="0" Margin="0,0,10,8" VerticalAlignment="Center" FontWeight="Medium" Text="LunedÃ¬" />
                                <ComboBox Grid.Row="0" Grid.Column="1" Margin="0,0,0,8" DisplayMemberPath="DisplayText" ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding MondayDose}" Style="{StaticResource DoseComboBoxStyle}" />

                                <!--  MartedÃ¬  -->
                                <TextBlock Grid.Row="1" Grid.Column="0" Margin="0,0,10,8" VerticalAlignment="Center" FontWeight="Medium" Text="MartedÃ¬" />
                                <ComboBox Grid.Row="1" Grid.Column="1" Margin="0,0,0,8" DisplayMemberPath="DisplayText" ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding TuesdayDose}" Style="{StaticResource DoseComboBoxStyle}" />

                                <!--  MercoledÃ¬  -->
                                <TextBlock Grid.Row="2" Grid.Column="0" Margin="0,0,10,8" VerticalAlignment="Center" FontWeight="Medium" Text="MercoledÃ¬" />
                                <ComboBox Grid.Row="2" Grid.Column="1" Margin="0,0,0,8" DisplayMemberPath="DisplayText" ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding WednesdayDose}" Style="{StaticResource DoseComboBoxStyle}" />

                                <!--  GiovedÃ¬  -->
                                <TextBlock Grid.Row="3" Grid.Column="0" Margin="0,0,10,8" VerticalAlignment="Center" FontWeight="Medium" Text="GiovedÃ¬" />
                                <ComboBox Grid.Row="3" Grid.Column="1" Margin="0,0,0,8" DisplayMemberPath="DisplayText" ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding ThursdayDose}" Style="{StaticResource DoseComboBoxStyle}" />

                                <!--  VenerdÃ¬  -->
                                <TextBlock Grid.Row="4" Grid.Column="0" Margin="0,0,10,8" VerticalAlignment="Center" FontWeight="Medium" Text="VenerdÃ¬" />
                                <ComboBox Grid.Row="4" Grid.Column="1" Margin="0,0,0,8" DisplayMemberPath="DisplayText" ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding FridayDose}" Style="{StaticResource DoseComboBoxStyle}" />

                                <!--  Sabato  -->
                                <TextBlock Grid.Row="5" Grid.Column="0" Margin="0,0,10,8" VerticalAlignment="Center" FontWeight="Medium" Text="Sabato" />
                                <ComboBox Grid.Row="5" Grid.Column="1" Margin="0,0,0,8" DisplayMemberPath="DisplayText" ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SaturdayDose}" Style="{StaticResource DoseComboBoxStyle}" />

                                <!--  Domenica  -->
                                <TextBlock Grid.Row="6" Grid.Column="0" Margin="0,0,10,8" VerticalAlignment="Center" FontWeight="Medium" Text="Domenica" />
                                <ComboBox Grid.Row="6" Grid.Column="1" Margin="0,0,0,8" DisplayMemberPath="DisplayText" ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SundayDose}" Style="{StaticResource DoseComboBoxStyle}" />

                                <!--  Totale Settimanale  -->
                                <Border Grid.Row="8" Grid.Column="0" Grid.ColumnSpan="2" Padding="12" Background="#E3F2FD" CornerRadius="4">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                                            <TextBlock FontSize="14" FontWeight="SemiBold" Text="Totale Settimanale: " />
                                            <TextBlock FontSize="18" FontWeight="Bold" Foreground="#0078D4" Text="{Binding CurrentWeeklyDose, StringFormat=F1}" />
                                            <TextBlock Margin="3,0,0,0" FontSize="14" FontWeight="SemiBold" Text=" mg" />
                                        </StackPanel>
                                        <TextBlock Grid.Column="1" VerticalAlignment="Center" FontSize="12" Foreground="#666666">
                                            <Run Text="(" /><Run Text="{Binding CurrentWeeklyTablets, Mode=OneWay}" /><Run Text=" cp/sett)" />
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </Grid>

                            <!--  Pulsanti Azioni Dosaggio  -->
                            <StackPanel Margin="0,15,0,0" Orientation="Horizontal">
                                <Button Margin="0,0,10,0" Command="{Binding LoadLastDosageCommand}" Content="ðŸ“‹ Carica ultimo dosaggio" Style="{StaticResource SecondaryButtonStyle}" />
                                <Button Command="{Binding RecalculateScheduleCommand}" Content="ðŸ”„ Ricalcola schema" Style="{StaticResource PrimaryButtonStyle}" ToolTip="Ridistribuisce equilibratamente il dosaggio settimanale corrente" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Azioni  -->
                    <StackPanel Margin="0,10,0,0" HorizontalAlignment="Right" Orientation="Horizontal">
                        <Button Content="ðŸ”„ Reset" Style="{StaticResource SecondaryButtonStyle}" />
                    </StackPanel>
                </StackPanel>

                <!--  COLONNA DESTRA: Suggerimenti, Storico e Grafico  -->
                <StackPanel Grid.Column="2">

                    <!--  Pannello Suggerimenti  -->
                    <Border Style="{StaticResource CardStyle}" Visibility="{Binding HasSuggestions, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Style="{StaticResource SectionHeaderStyle}" Text="ðŸŽ¯ SUGGERIMENTO DOSAGGIO" />

                            <!--  Toggle Linee Guida  -->
                            <StackPanel Margin="0,0,0,15" Orientation="Horizontal">
                                <RadioButton Margin="0,0,20,0" Content="FCSA-SIMG (Italia)" FontSize="13" GroupName="Guidelines" IsChecked="{Binding SelectedGuideline, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=FCSA}" />
                                <RadioButton Content="ACCP (USA)" FontSize="13" GroupName="Guidelines" IsChecked="{Binding SelectedGuideline, Converter={StaticResource EnumToBoolConverter}, ConverterParameter=ACCP}" />
                            </StackPanel>

                            <!--  Status INR  -->
                            <Border Margin="0,0,0,15" Padding="15,10" CornerRadius="4">
                                <Border.Background>
                                    <SolidColorBrush Color="{Binding InrStatusColor}" />
                                </Border.Background>
                                <TextBlock FontSize="16" FontWeight="Bold" Foreground="White" Text="{Binding InrStatusText}" TextAlignment="Center" />
                            </Border>

                            <!--  Avviso Sospensione Dose  -->
                            <Border Margin="0,0,0,10" Padding="12" Background="#FFF9C4" BorderBrush="#FFB300" BorderThickness="2" CornerRadius="4" Visibility="{Binding HasDoseSuspension, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock FontSize="13" FontWeight="SemiBold" Foreground="#E65100" Text="{Binding DoseSuspensionText}" TextAlignment="Center" TextWrapping="Wrap" />
                            </Border>

                            <!--  Checkbox Ignora Warning (visibile sempre quando ci sono warning attivi)  -->
                            <CheckBox Margin="0,0,0,15" Content="Ignora warning nelle esportazioni" FontSize="12" FontWeight="Medium" Foreground="#666666" IsChecked="{Binding IsWarningIgnored, Mode=TwoWay}"
                                      Visibility="{Binding HasActiveWarnings, Converter={StaticResource BoolToVisibilityConverter}}"
                                      ToolTip="Se selezionato, esclude gli alert e i warning dalla copia/esportazione del testo e dal PDF" />

                            <!--  Nuova Dose Suggerita  -->
                            <Border Margin="0,0,0,15" Padding="15" Background="#F0F8FF" CornerRadius="4">
                                <StackPanel>
                                    <TextBlock FontSize="12" Foreground="#666666" Text="NUOVA DOSE SETTIMANALE" />
                                    <TextBlock FontSize="32" FontWeight="Bold" Foreground="#0078D4" TextAlignment="Center">
                                        <Run Text="{Binding CurrentSuggestedWeeklyDose, Mode=OneWay, StringFormat=F1}" />
                                        <Run FontSize="20" Text="mg" />
                                    </TextBlock>
                                    <TextBlock FontSize="13" Foreground="#666666" TextAlignment="Center">
                                        <Run Text="(" /><Run Text="{Binding CurrentPercentageAdjustment, Mode=OneWay, StringFormat=+0.0;-0.0}" /><Run Text="%)" />
                                    </TextBlock>
                                </StackPanel>
                            </Border>

                            <!--  Schema Settimanale Distribuito (testo compatto)  -->
                            <TextBlock Margin="0,0,0,8" FontSize="12" FontWeight="SemiBold" Foreground="#666666" Text="SCHEMA SETTIMANALE (distribuzione equilibrata)" />
                            <Border Margin="0,0,0,15" Padding="12" Background="#E8F5E9" BorderBrush="#4CAF50" BorderThickness="1" CornerRadius="4">
                                <TextBlock FontFamily="Consolas" FontSize="13" FontWeight="SemiBold" Foreground="#2E7D32" Text="{Binding SuggestedScheduleText}" TextWrapping="Wrap" />
                            </Border>

                            <!--  Dosi giornaliere suggerite (dropdown dettagliati)  -->
                            <TextBlock Margin="0,0,0,8" FontSize="12" FontWeight="SemiBold" Foreground="#666666" Text="DETTAGLIO DOSAGGIO GIORNALIERO SUGGERITO" />

                            <Border Margin="0,0,0,15" Padding="12" Background="#F0F8FF" CornerRadius="4">
                                <Border.BorderBrush>
                                    <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                </Border.BorderBrush>
                                <Border.BorderThickness>
                                    <Binding Path="IsEditMode">
                                        <Binding.Converter>
                                            <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                        </Binding.Converter>
                                    </Binding>
                                </Border.BorderThickness>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="75" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <!--  LunedÃ¬  -->
                                    <TextBlock Grid.Row="0" Grid.Column="0" Margin="0,0,8,6" VerticalAlignment="Center" FontSize="11" FontWeight="Medium" Text="LunedÃ¬" />
                                    <ComboBox Grid.Row="0" Grid.Column="1" Margin="0,0,0,6" DisplayMemberPath="DisplayText" FontSize="11"
                                              ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SuggestedMondayDose, Mode=TwoWay}"
                                              Style="{StaticResource DoseComboBoxStyle}"
                                              IsEnabled="{Binding IsEditMode}">
                                        <ComboBox.BorderBrush>
                                            <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                        </ComboBox.BorderBrush>
                                        <ComboBox.BorderThickness>
                                            <Binding Path="IsEditMode">
                                                <Binding.Converter>
                                                    <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                                </Binding.Converter>
                                            </Binding>
                                        </ComboBox.BorderThickness>
                                    </ComboBox>

                                    <!--  MartedÃ¬  -->
                                    <TextBlock Grid.Row="1" Grid.Column="0" Margin="0,0,8,6" VerticalAlignment="Center" FontSize="11" FontWeight="Medium" Text="MartedÃ¬" />
                                    <ComboBox Grid.Row="1" Grid.Column="1" Margin="0,0,0,6" DisplayMemberPath="DisplayText" FontSize="11"
                                              ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SuggestedTuesdayDose, Mode=TwoWay}"
                                              Style="{StaticResource DoseComboBoxStyle}"
                                              IsEnabled="{Binding IsEditMode}">
                                        <ComboBox.BorderBrush>
                                            <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                        </ComboBox.BorderBrush>
                                        <ComboBox.BorderThickness>
                                            <Binding Path="IsEditMode">
                                                <Binding.Converter>
                                                    <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                                </Binding.Converter>
                                            </Binding>
                                        </ComboBox.BorderThickness>
                                    </ComboBox>

                                    <!--  MercoledÃ¬  -->
                                    <TextBlock Grid.Row="2" Grid.Column="0" Margin="0,0,8,6" VerticalAlignment="Center" FontSize="11" FontWeight="Medium" Text="MercoledÃ¬" />
                                    <ComboBox Grid.Row="2" Grid.Column="1" Margin="0,0,0,6" DisplayMemberPath="DisplayText" FontSize="11"
                                              ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SuggestedWednesdayDose, Mode=TwoWay}"
                                              Style="{StaticResource DoseComboBoxStyle}"
                                              IsEnabled="{Binding IsEditMode}">
                                        <ComboBox.BorderBrush>
                                            <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                        </ComboBox.BorderBrush>
                                        <ComboBox.BorderThickness>
                                            <Binding Path="IsEditMode">
                                                <Binding.Converter>
                                                    <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                                </Binding.Converter>
                                            </Binding>
                                        </ComboBox.BorderThickness>
                                    </ComboBox>

                                    <!--  GiovedÃ¬  -->
                                    <TextBlock Grid.Row="3" Grid.Column="0" Margin="0,0,8,6" VerticalAlignment="Center" FontSize="11" FontWeight="Medium" Text="GiovedÃ¬" />
                                    <ComboBox Grid.Row="3" Grid.Column="1" Margin="0,0,0,6" DisplayMemberPath="DisplayText" FontSize="11"
                                              ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SuggestedThursdayDose, Mode=TwoWay}"
                                              Style="{StaticResource DoseComboBoxStyle}"
                                              IsEnabled="{Binding IsEditMode}">
                                        <ComboBox.BorderBrush>
                                            <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                        </ComboBox.BorderBrush>
                                        <ComboBox.BorderThickness>
                                            <Binding Path="IsEditMode">
                                                <Binding.Converter>
                                                    <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                                </Binding.Converter>
                                            </Binding>
                                        </ComboBox.BorderThickness>
                                    </ComboBox>

                                    <!--  VenerdÃ¬  -->
                                    <TextBlock Grid.Row="4" Grid.Column="0" Margin="0,0,8,6" VerticalAlignment="Center" FontSize="11" FontWeight="Medium" Text="VenerdÃ¬" />
                                    <ComboBox Grid.Row="4" Grid.Column="1" Margin="0,0,0,6" DisplayMemberPath="DisplayText" FontSize="11"
                                              ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SuggestedFridayDose, Mode=TwoWay}"
                                              Style="{StaticResource DoseComboBoxStyle}"
                                              IsEnabled="{Binding IsEditMode}">
                                        <ComboBox.BorderBrush>
                                            <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                        </ComboBox.BorderBrush>
                                        <ComboBox.BorderThickness>
                                            <Binding Path="IsEditMode">
                                                <Binding.Converter>
                                                    <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                                </Binding.Converter>
                                            </Binding>
                                        </ComboBox.BorderThickness>
                                    </ComboBox>

                                    <!--  Sabato  -->
                                    <TextBlock Grid.Row="5" Grid.Column="0" Margin="0,0,8,6" VerticalAlignment="Center" FontSize="11" FontWeight="Medium" Text="Sabato" />
                                    <ComboBox Grid.Row="5" Grid.Column="1" Margin="0,0,0,6" DisplayMemberPath="DisplayText" FontSize="11"
                                              ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SuggestedSaturdayDose, Mode=TwoWay}"
                                              Style="{StaticResource DoseComboBoxStyle}"
                                              IsEnabled="{Binding IsEditMode}">
                                        <ComboBox.BorderBrush>
                                            <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                        </ComboBox.BorderBrush>
                                        <ComboBox.BorderThickness>
                                            <Binding Path="IsEditMode">
                                                <Binding.Converter>
                                                    <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                                </Binding.Converter>
                                            </Binding>
                                        </ComboBox.BorderThickness>
                                    </ComboBox>

                                    <!--  Domenica  -->
                                    <TextBlock Grid.Row="6" Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Center" FontSize="11" FontWeight="Medium" Text="Domenica" />
                                    <ComboBox Grid.Row="6" Grid.Column="1" Margin="0,0,0,0" DisplayMemberPath="DisplayText" FontSize="11"
                                              ItemsSource="{Binding AvailableDoses}" SelectedItem="{Binding SuggestedSundayDose, Mode=TwoWay}"
                                              Style="{StaticResource DoseComboBoxStyle}"
                                              IsEnabled="{Binding IsEditMode}">
                                        <ComboBox.BorderBrush>
                                            <SolidColorBrush Color="{Binding IsEditMode, Converter={StaticResource BoolToColorConverter}}" />
                                        </ComboBox.BorderBrush>
                                        <ComboBox.BorderThickness>
                                            <Binding Path="IsEditMode">
                                                <Binding.Converter>
                                                    <converters:BoolToThicknessConverter TrueValue="2" FalseValue="1" />
                                                </Binding.Converter>
                                            </Binding>
                                        </ComboBox.BorderThickness>
                                    </ComboBox>
                                </Grid>
                            </Border>

                            <!--  Pulsanti Gestione Schema  -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                <!--  Pulsante Applica Schema (sempre visibile)  -->
                                <Button Margin="0,0,8,0" HorizontalAlignment="Left"
                                        Command="{Binding ApplySuggestedScheduleCommand}"
                                        Content="âœ… Applica schema suggerito"
                                        Style="{StaticResource SuccessButtonStyle}"
                                        ToolTip="Imposta le dosi giornaliere con lo schema suggerito" />

                                <!--  Pulsante Modifica Schema (visibile solo se NON in edit mode)  -->
                                <Button Margin="0,0,0,0" HorizontalAlignment="Left"
                                        Command="{Binding EditSchemaCommand}"
                                        Content="âœï¸ Modifica schema"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        ToolTip="Modifica manualmente il dosaggio suggerito">
                                    <Button.Visibility>
                                        <Binding Path="IsEditMode">
                                            <Binding.Converter>
                                                <converters:BooleanToVisibilityConverter Inverted="True" />
                                            </Binding.Converter>
                                        </Binding>
                                    </Button.Visibility>
                                </Button>

                                <!--  Pulsante Salva (visibile solo in edit mode)  -->
                                <Button Margin="0,0,8,0" HorizontalAlignment="Left"
                                        Command="{Binding SaveSchemaCommand}"
                                        Content="ðŸ’¾ Salva"
                                        Style="{StaticResource SuccessButtonStyle}"
                                        ToolTip="Salva le modifiche manuali al dosaggio">
                                    <Button.Visibility>
                                        <Binding Path="IsEditMode">
                                            <Binding.Converter>
                                                <converters:BooleanToVisibilityConverter />
                                            </Binding.Converter>
                                        </Binding>
                                    </Button.Visibility>
                                </Button>

                                <!--  Pulsante Annulla (visibile solo in edit mode)  -->
                                <Button Margin="0,0,0,0" HorizontalAlignment="Left"
                                        Command="{Binding CancelEditCommand}"
                                        Content="âŒ Annulla"
                                        Style="{StaticResource DangerButtonStyle}"
                                        ToolTip="Annulla le modifiche e ripristina i valori originali">
                                    <Button.Visibility>
                                        <Binding Path="IsEditMode">
                                            <Binding.Converter>
                                                <converters:BooleanToVisibilityConverter />
                                            </Binding.Converter>
                                        </Binding>
                                    </Button.Visibility>
                                </Button>
                            </StackPanel>

                            <!--  Prossimo Controllo  -->
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" FontSize="13" Text="ðŸ—“ Prossimo controllo: " />

                                <!--  Versione Read-Only (quando NON in edit mode)  -->
                                <TextBlock Grid.Column="1" VerticalAlignment="Center" FontSize="14" FontWeight="SemiBold" Foreground="#0078D4">
                                    <TextBlock.Visibility>
                                        <Binding Path="IsEditMode">
                                            <Binding.Converter>
                                                <converters:BooleanToVisibilityConverter Inverted="True" />
                                            </Binding.Converter>
                                        </Binding>
                                    </TextBlock.Visibility>
                                    <Run Text="tra " /><Run Text="{Binding ActiveSuggestion.NextControlDays}" /><Run Text=" giorni" />
                                </TextBlock>

                                <!--  Versione Editabile (quando in edit mode)  -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <StackPanel.Visibility>
                                        <Binding Path="IsEditMode">
                                            <Binding.Converter>
                                                <converters:BooleanToVisibilityConverter />
                                            </Binding.Converter>
                                        </Binding>
                                    </StackPanel.Visibility>
                                    <TextBlock VerticalAlignment="Center" FontSize="14" Text="tra " />
                                    <TextBox Width="60" Margin="4,0" Padding="4,2" FontSize="14" FontWeight="SemiBold"
                                             Text="{Binding EditableNextControlDays, UpdateSourceTrigger=PropertyChanged}"
                                             BorderBrush="#FF9800" BorderThickness="2"
                                             ToolTip="Modifica il numero di giorni per il prossimo controllo" />
                                    <TextBlock VerticalAlignment="Center" FontSize="14" Text=" giorni" />
                                </StackPanel>
                            </Grid>

                            <!--  Livello Urgenza  -->
                            <Border Margin="0,0,0,15" Padding="12,8" CornerRadius="4">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ActiveSuggestion.UrgencyLevel}" Value="0">
                                                <Setter Property="Background" Value="#E8F5E9" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding ActiveSuggestion.UrgencyLevel}" Value="1">
                                                <Setter Property="Background" Value="#FFF3E0" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding ActiveSuggestion.UrgencyLevel}" Value="2">
                                                <Setter Property="Background" Value="#FFEBEE" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <StackPanel>
                                    <TextBlock FontSize="11" Foreground="#666666" Text="LIVELLO URGENZA" />
                                    <TextBlock FontSize="14" FontWeight="Bold">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding ActiveSuggestion.UrgencyLevel}" Value="0">
                                                        <Setter Property="Foreground" Value="#388E3C" />
                                                        <Setter Property="Text" Value="âœ“ ROUTINE" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ActiveSuggestion.UrgencyLevel}" Value="1">
                                                        <Setter Property="Foreground" Value="#F57C00" />
                                                        <Setter Property="Text" Value="âš  URGENTE" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ActiveSuggestion.UrgencyLevel}" Value="2">
                                                        <Setter Property="Foreground" Value="#D32F2F" />
                                                        <Setter Property="Text" Value="ðŸ”´ EMERGENZA" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </StackPanel>
                            </Border>

                            <!--  Note Cliniche  -->
                            <TextBlock Margin="0,0,0,8" FontSize="12" FontWeight="SemiBold" Foreground="#666666" Text="NOTE CLINICHE" />

                            <!--  Versione Read-Only (quando NON in edit mode)  -->
                            <TextBlock Margin="0,0,0,15" FontSize="12" Foreground="#333333" Text="{Binding ActiveSuggestion.ClinicalNotes}" TextWrapping="Wrap">
                                <TextBlock.Visibility>
                                    <Binding Path="IsEditMode">
                                        <Binding.Converter>
                                            <converters:BooleanToVisibilityConverter Inverted="True" />
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Visibility>
                            </TextBlock>

                            <!--  Versione Editabile (quando in edit mode)  -->
                            <TextBox Margin="0,0,0,15" MinHeight="60" Padding="8" FontSize="12"
                                     Text="{Binding EditableClinicalNotes, UpdateSourceTrigger=PropertyChanged}"
                                     TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"
                                     BorderBrush="#FF9800" BorderThickness="2"
                                     ToolTip="Modifica le note cliniche">
                                <TextBox.Visibility>
                                    <Binding Path="IsEditMode">
                                        <Binding.Converter>
                                            <converters:BooleanToVisibilityConverter />
                                        </Binding.Converter>
                                    </Binding>
                                </TextBox.Visibility>
                            </TextBox>

                            <!--  Warnings (se presenti)  -->
                            <ItemsControl Margin="0,0,0,15" ItemsSource="{Binding ActiveSuggestion.Warnings}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="0,0,0,5" Padding="10,8" Background="#FFF3E0" BorderBrush="#FF9800" BorderThickness="1" CornerRadius="4">
                                            <TextBlock FontSize="12" FontWeight="SemiBold" Foreground="#E65100" Text="{Binding}" TextWrapping="Wrap" />
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <!--  Raccomandazioni Speciali (Vitamina K, PCC, EBPM)  -->
                            <StackPanel>
                                <!--  Vitamina K  -->
                                <Border Margin="0,0,0,10" Padding="12,10" Background="#E3F2FD" BorderBrush="#2196F3" BorderThickness="1" CornerRadius="4" Visibility="{Binding ActiveSuggestion.RequiresVitaminK, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock FontSize="13" FontWeight="Bold" Foreground="#1976D2" Text="ðŸ’Š VITAMINA K RACCOMANDATA" />
                                        <TextBlock Margin="0,5,0,0" FontSize="12" Foreground="#333333">
                                            <Run Text="Dose:" />
                                            <Run FontWeight="Bold" Text="{Binding ActiveSuggestion.VitaminKDoseMg, StringFormat=F1}" />
                                            <Run Text="mg" />
                                        </TextBlock>
                                        <TextBlock FontSize="12" Foreground="#333333">
                                            <Run Text="Via:" />
                                            <Run FontWeight="Bold" Text="{Binding ActiveSuggestion.VitaminKRoute}" />
                                        </TextBlock>
                                    </StackPanel>
                                </Border>

                                <!--  PCC (Concentrato Complesso Protrombinico)  -->
                                <Border Margin="0,0,0,10" Padding="12,10" Background="#FFEBEE" BorderBrush="#F44336" BorderThickness="2" CornerRadius="4" Visibility="{Binding ActiveSuggestion.RequiresPCC, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock FontSize="13" FontWeight="Bold" Foreground="#C62828" Text="ðŸ”´ PCC RACCOMANDATO (EMERGENZA)" />
                                        <TextBlock Margin="0,5,0,0" FontSize="12" FontWeight="SemiBold" Foreground="#333333" Text="{Binding ActiveSuggestion.DosePCC}" />
                                        <TextBlock Margin="0,3,0,0" FontSize="11" Foreground="#666666" Text="Alternativa: Plasma fresco congelato (se PCC non disponibile)" Visibility="{Binding ActiveSuggestion.RequiresPlasma, Converter={StaticResource BoolToVisibilityConverter}}" />
                                    </StackPanel>
                                </Border>

                                <!--  EBPM  -->
                                <Border Margin="0,0,0,10" Padding="12,10" Background="#FFF3E0" BorderBrush="#FF9800" BorderThickness="1" CornerRadius="4" Visibility="{Binding ActiveSuggestion.RequiresEBPM, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock FontSize="13" FontWeight="Bold" Foreground="#E65100" Text="âš  EBPM RACCOMANDATA (BRIDGING)" />
                                        <TextBlock Margin="0,5,0,0" FontSize="12" Foreground="#333333" Text="Enoxaparina 70 UI/kg x 2/die fino a INR â‰¥2.0 per 24h" TextWrapping="Wrap" />
                                    </StackPanel>
                                </Border>

                                <!--  Ricovero Richiesto  -->
                                <Border Margin="0,0,0,10" Padding="12,10" Background="#FFCDD2" BorderBrush="#D32F2F" BorderThickness="2" CornerRadius="4" Visibility="{Binding ActiveSuggestion.RequiresHospitalization, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <TextBlock FontSize="14" FontWeight="Bold" Foreground="#B71C1C" Text="ðŸ¥ RICOVERO OSPEDALIERO OBBLIGATORIO" TextAlignment="Center" />
                                </Border>
                            </StackPanel>

                            <!--  Azioni Salvataggio ed Export  -->
                            <StackPanel Margin="0,15,0,0" HorizontalAlignment="Right" Orientation="Horizontal">
                                <!--  Pulsante Salva Controllo con sfondo arancione  -->
                                <Button Margin="0,0,10,0" Command="{Binding SaveControlCommand}" Content="ðŸ’¾ Salva Controllo" ToolTip="Salva il controllo INR nel database">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="#FF9800"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                            <Setter Property="Padding" Value="15,8"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                            <Setter Property="Cursor" Value="Hand"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" CornerRadius="4" Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#FB8C00"/>
                                                </Trigger>
                                                <Trigger Property="IsPressed" Value="True">
                                                    <Setter Property="Background" Value="#F57C00"/>
                                                </Trigger>
                                                <Trigger Property="IsEnabled" Value="False">
                                                    <Setter Property="Background" Value="#CCCCCC"/>
                                                    <Setter Property="Foreground" Value="#666666"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <Button Margin="0,0,8,0" Command="{Binding CopyShortToClipboardCommand}" Content="ðŸ“ Copia Breve" Style="{StaticResource SecondaryButtonStyle}" ToolTip="Copia versione concisa" />
                                <Button Margin="0,0,8,0" Command="{Binding CopyToClipboardCommand}" Content="ðŸ“‹ Copia Completo" Style="{StaticResource SecondaryButtonStyle}" ToolTip="Copia report completo" />
                                <Button Margin="0,0,8,0" Command="{Binding ExportToFileCommand}" Content="ðŸ’¾ Esporta TXT" Style="{StaticResource SecondaryButtonStyle}" ToolTip="Esporta in file di testo" />
                                <Button Command="{Binding ExportToPdfCommand}" Content="ðŸ“„ Stampa PDF" Style="{StaticResource SecondaryButtonStyle}" ToolTip="Genera e stampa PDF" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Storico INR (tabella)  -->
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Style="{StaticResource SectionHeaderStyle}" Text="ðŸ“ˆ STORICO CONTROLLI" />
                                <Button Grid.Column="1" Margin="0,-5,0,0" Padding="8,4" VerticalAlignment="Top" Command="{Binding ToggleChartCommand}" FontSize="11" Style="{StaticResource SmallButtonStyle}" ToolTip="Mostra/nascondi grafico andamento INR">
                                    <Button.Content>
                                        <TextBlock>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="ðŸ“‰ Nascondi grafico" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsChartVisible}" Value="False">
                                                            <Setter Property="Text" Value="ðŸ“Š Mostra grafico" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Button.Content>
                                </Button>
                            </Grid>

                            <DataGrid
                                Height="200"
                                AlternatingRowBackground="#F9F9F9"
                                AutoGenerateColumns="False"
                                CanUserResizeRows="False"
                                GridLinesVisibility="None"
                                HeadersVisibility="Column"
                                IsReadOnly="True"
                                ItemsSource="{Binding InrHistory}"
                                SelectedItem="{Binding SelectedHistoryItem}"
                                SelectionMode="Single">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Width="90" Binding="{Binding FormattedDate}" Header="Data" />
                                    <DataGridTextColumn Width="50" Binding="{Binding INRValue, StringFormat=F1}" Header="INR" />
                                    <DataGridTextColumn Width="80" Binding="{Binding Status}" Header="Status" />
                                    <DataGridTextColumn Width="100" Binding="{Binding CurrentWeeklyDose, StringFormat=F1}" Header="Dose (mg/sett)" />
                                    <DataGridTextColumn Width="*" Binding="{Binding PhaseDescription}" Header="Fase" />
                                </DataGrid.Columns>
                            </DataGrid>

                            <StackPanel Margin="0,10,0,0" HorizontalAlignment="Right" Orientation="Horizontal">
                                <Button Margin="0,0,10,0" Command="{Binding LoadHistoryItemCommand}" Content="ðŸ“‚ Carica selezionato" Style="{StaticResource SecondaryButtonStyle}" />
                                <Button Command="{Binding DeleteHistoryItemCommand}" Content="ðŸ—‘ Elimina" ToolTip="Elimina il controllo INR selezionato">
                                    <Button.Style>
                                        <Style BasedOn="{StaticResource SecondaryButtonStyle}" TargetType="Button">
                                            <Setter Property="Foreground" Value="#E81123" />
                                            <Setter Property="BorderBrush" Value="#E81123" />
                                            <Style.Triggers>
                                                <Trigger Property="IsEnabled" Value="False">
                                                    <Setter Property="Opacity" Value="0.5" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!--  Grafico INR (collapsibile)  -->
                    <Border Style="{StaticResource CardStyle}" Visibility="{Binding IsChartVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                        <StackPanel>
                            <TextBlock Style="{StaticResource SectionHeaderStyle}" Text="ðŸ“Š GRAFICO ANDAMENTO INR" />
                            <charts:INRChartView Height="350" DataContext="{Binding ChartViewModel}" />
                        </StackPanel>
                    </Border>

                </StackPanel>
            </Grid>
        </ScrollViewer>
    </Grid>
</Window>
