<Window x:Class="WarfarinManager.UI.Views.Dialogs.ImportPatientsDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:WarfarinManager.UI.Converters"
        mc:Ignorable="d"
        Title="Importa Pazienti da Milleps"
        Height="700" Width="900"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:EnumToBooleanConverter x:Key="EnumToBooleanConverter"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="Importazione Pazienti da Database Milleps"
                      FontSize="20" FontWeight="Bold"
                      Foreground="{DynamicResource PrimaryBrush}"/>
            <TextBlock Text="Importa pazienti in terapia con Warfarin dal gestionale Milleps"
                      FontSize="12" Opacity="0.7" Margin="0,5,0,0"/>
        </StackPanel>

        <!-- Connection Test Section -->
        <Border Grid.Row="1"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="15"
                Margin="0,0,0,15">
            <StackPanel>
                <TextBlock Text="Test Connessione" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,10"/>
                <Button Content="Testa Connessione al Database"
                       Command="{Binding TestConnectionCommand}"
                       HorizontalAlignment="Left"
                       Padding="15,8"/>
            </StackPanel>
        </Border>

        <!-- Import Parameters -->
        <Border Grid.Row="2"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="15"
                Margin="0,0,0,15">
            <StackPanel>
                <TextBlock Text="Parametri Importazione" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,10"/>

                <TextBlock Text="Codice Fiscale Medico:" Margin="0,0,0,5"/>
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBox Grid.Column="0"
                            Text="{Binding CodiceFiscaleMedico, UpdateSourceTrigger=PropertyChanged}"
                            Padding="8"
                            Margin="0,0,10,0"/>

                    <Button Grid.Column="1"
                           Content="Importa Pazienti"
                           Command="{Binding ImportPatientsCommand}"
                           Padding="15,8"/>
                </Grid>

                <TextBlock Text="Seleziona pazienti in terapia con:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                <StackPanel Orientation="Horizontal">
                    <RadioButton Content="Warfarin"
                                IsChecked="{Binding SelectedTherapyType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=Warfarin}"
                                Margin="0,0,15,0"/>
                    <RadioButton Content="DOAC"
                                IsChecked="{Binding SelectedTherapyType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=DOAC}"
                                Margin="0,0,15,0"/>
                    <RadioButton Content="Entrambi"
                                IsChecked="{Binding SelectedTherapyType, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter=Both}"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Results DataGrid -->
        <Border Grid.Row="3"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="15"
                Margin="0,0,0,15"
                Visibility="{Binding HasImportedData, Converter={StaticResource BoolToVis}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                    <TextBlock Text="Pazienti Trovati" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding ImportedPatients.Count, StringFormat=' ({0})'}"
                              FontSize="14" VerticalAlignment="Center" Margin="5,0,0,0"/>
                </StackPanel>

                <DataGrid Grid.Row="1"
                         ItemsSource="{Binding ImportedPatients}"
                         AutoGenerateColumns="False"
                         CanUserAddRows="False"
                         CanUserDeleteRows="False"
                         SelectionMode="Extended"
                         GridLinesVisibility="Horizontal"
                         HeadersVisibility="Column"
                         AlternatingRowBackground="{DynamicResource AlternateRowBrush}"
                         RowBackground="{DynamicResource RowBackgroundBrush}">
                    <DataGrid.Columns>
                        <DataGridCheckBoxColumn Header="Sel." Width="50" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        <DataGridTextColumn Header="Cognome" Binding="{Binding Cognome}" Width="*" MinWidth="100" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Nome" Binding="{Binding Nome}" Width="*" MinWidth="100" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Data Nascita" Binding="{Binding Nascita, StringFormat=dd/MM/yyyy}" Width="100" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Codice Fiscale" Binding="{Binding CodiceFiscale}" Width="120" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Anticoagulante" Binding="{Binding Anticoagulante}" Width="110" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Inizio TAO" Binding="{Binding DataInizio, StringFormat=dd/MM/yyyy}" Width="90" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Telefono" Binding="{Binding TelCell}" Width="100" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="*" MinWidth="120" IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>

                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,10,0,0" HorizontalAlignment="Left">
                    <Button Content="Seleziona Tutti" Command="{Binding SelectAllCommand}" Padding="10,5" Margin="0,0,10,0"/>
                    <Button Content="Deseleziona Tutti" Command="{Binding DeselectAllCommand}" Padding="10,5"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="4"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="10"
                Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <ProgressBar Grid.Column="0"
                            IsIndeterminate="True"
                            Width="100"
                            Height="20"
                            Margin="0,0,10,0"
                            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"/>

                <TextBlock Grid.Column="1"
                          Text="{Binding StatusMessage}"
                          VerticalAlignment="Center"
                          TextWrapping="Wrap"/>
            </Grid>
        </Border>

        <!-- Action Buttons -->
        <StackPanel Grid.Row="5" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Content="Importa Pazienti Selezionati"
                   Command="{Binding SavePatientsCommand}"
                   IsEnabled="{Binding HasImportedData}"
                   Padding="15,8"
                   Margin="0,0,10,0"/>
            <Button Content="Chiudi"
                   IsCancel="True"
                   Padding="15,8"/>
        </StackPanel>
    </Grid>
</Window>
