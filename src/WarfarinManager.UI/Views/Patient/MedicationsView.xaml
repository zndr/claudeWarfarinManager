<UserControl x:Class="WarfarinManager.UI.Views.Patient.MedicationsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </UserControl.Resources>
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <TextBlock Grid.Column="0" 
                       Text="FARMACI CONCOMITANTI" 
                       FontSize="18" 
                       FontWeight="Bold" 
                       Foreground="#0078D4"/>
            
            <Button Grid.Column="1"
                    Content="âž• Aggiungi Farmaco"
                    Command="{Binding OpenAddMedicationDialogCommand}"
                    Background="#0078D4"
                    Foreground="White"
                    FontWeight="SemiBold"
                    Padding="15,8"
                    BorderThickness="0"
                    Cursor="Hand">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}"
                                            CornerRadius="4"
                                            Padding="{TemplateBinding Padding}">
                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#106EBE"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </Grid>

        <!-- Alert Alto Rischio -->
        <Border Grid.Row="1"
                Visibility="{Binding HasHighRiskInteractions, Converter={StaticResource BoolToVisibilityConverter}}"
                Background="#FFF4F4"
                BorderBrush="#E81123"
                BorderThickness="2"
                CornerRadius="4"
                Padding="15"
                Margin="0,0,0,15">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="âš ï¸" FontSize="24" Margin="0,0,10,0"/>
                <StackPanel>
                    <TextBlock Text="ATTENZIONE: Interazioni ad Alto Rischio" 
                               FontWeight="Bold" 
                               Foreground="#E81123"
                               FontSize="14"/>
                    <TextBlock Margin="0,5,0,0" Foreground="#666666">
                        <Run Text="Rilevate"/>
                        <Run Text="{Binding HighRiskCount, Mode=OneWay}" FontWeight="Bold"/>
                        <Run Text="interazioni ad alto rischio. Monitorare INR ogni 3-7 giorni."/>
                    </TextBlock>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Lista Farmaci o Messaggio Vuoto -->
        <Grid Grid.Row="2">
            <!-- DataGrid Farmaci -->
            <DataGrid ItemsSource="{Binding ActiveMedications}"
                      SelectedItem="{Binding SelectedMedication}"
                      Visibility="{Binding HasActiveMedications, Converter={StaticResource BoolToVisibilityConverter}}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      RowHeight="50"
                      HeadersVisibility="Column"
                      GridLinesVisibility="Horizontal"
                      AlternatingRowBackground="#F9F9F9"
                      CanUserResizeRows="False">
                
                <DataGrid.ColumnHeaderStyle>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="Background" Value="#E8E8E8"/>
                        <Setter Property="FontWeight" Value="SemiBold"/>
                        <Setter Property="Padding" Value="10"/>
                    </Style>
                </DataGrid.ColumnHeaderStyle>
                
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Farmaco" Binding="{Binding MedicationName}" Width="200">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    
                    <DataGridTextColumn Header="Dosaggio" Binding="{Binding Dosage}" Width="150"/>
                    <DataGridTextColumn Header="Frequenza" Binding="{Binding Frequency}" Width="120"/>
                    <DataGridTextColumn Header="Data Inizio" Binding="{Binding StartDateFormatted}" Width="100"/>
                    
                    <DataGridTextColumn Header="Durata" Binding="{Binding DurationText}" Width="100">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="#666666"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    
                    <DataGridTemplateColumn Header="Interazione" Width="150">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Background="{Binding InteractionBadgeColor}"
                                        CornerRadius="4"
                                        Padding="8,4"
                                        ToolTip="{Binding InteractionDetails}">
                                    <TextBlock Text="{Binding InteractionBadgeText}"
                                               Foreground="White"
                                               FontWeight="Bold"
                                               FontSize="10"
                                               TextAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <DataGridTemplateColumn Header="Azioni" Width="*">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Button Content="ðŸ›‘ Stop"
                                            Command="{Binding DataContext.StopMedicationAsyncCommand, 
                                                            RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            Background="#D13438"
                                            Foreground="White"
                                            Padding="10,5"
                                            Margin="5,0"
                                            BorderThickness="0"
                                            Cursor="Hand">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="Button">
                                                            <Border Background="{TemplateBinding Background}"
                                                                    CornerRadius="4"
                                                                    Padding="{TemplateBinding Padding}">
                                                                <ContentPresenter/>
                                                            </Border>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#A72B2E"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
                
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsHighRisk}" Value="True">
                                <Setter Property="Background" Value="#FFF9F9"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
            </DataGrid>

            <!-- Messaggio Lista Vuota -->
            <StackPanel VerticalAlignment="Center" 
                        HorizontalAlignment="Center"
                        Visibility="{Binding HasNoActiveMedications, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="ðŸ’Š" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,15"/>
                <TextBlock Text="Nessun farmaco registrato" 
                           FontSize="16" 
                           Foreground="#A0A0A0"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Clicca su 'Aggiungi Farmaco' per iniziare" 
                           FontSize="13" 
                           Foreground="#A0A0A0"
                           HorizontalAlignment="Center"
                           Margin="0,5,0,0"/>
            </StackPanel>
        </Grid>

        <!-- Dialog Aggiungi Farmaco -->
        <Grid Grid.RowSpan="3"
              Visibility="{Binding IsAddingMedication, Converter={StaticResource BoolToVisibilityConverter}}"
              Background="#80000000">
            <Border Width="500"
                    Background="White"
                    CornerRadius="8"
                    Padding="30"
                    VerticalAlignment="Center">
                <StackPanel>
                    <TextBlock Text="AGGIUNGI FARMACO" 
                               FontSize="18" 
                               FontWeight="Bold"
                               Margin="0,0,0,20"/>
                    
                    <TextBlock Text="Nome Farmaco *" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding NewMedicationName, UpdateSourceTrigger=PropertyChanged}"
                             Padding="10"
                             Margin="0,0,0,15"/>
                    
                    <TextBlock Text="Dosaggio" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding NewDosage, UpdateSourceTrigger=PropertyChanged}"
                             Padding="10"
                             Margin="0,0,0,15"/>
                    
                    <TextBlock Text="Frequenza" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding NewFrequency, UpdateSourceTrigger=PropertyChanged}"
                             Padding="10"
                             Margin="0,0,0,15"/>
                    
                    <TextBlock Text="Data Inizio" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    <DatePicker SelectedDate="{Binding NewStartDate}"
                                Padding="10"
                                Margin="0,0,0,15"/>
                    
                    <!-- Messaggio Errore -->
                    <TextBlock Text="{Binding FormErrorMessage}"
                               Visibility="{Binding HasFormError, Converter={StaticResource BoolToVisibilityConverter}}"
                               Foreground="Red"
                               FontWeight="Bold"
                               Margin="0,0,0,15"
                               TextWrapping="Wrap"/>
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Annulla"
                                Command="{Binding CancelAddMedicationCommand}"
                                Background="#E0E0E0"
                                Padding="20,10"
                                Margin="0,0,10,0"
                                BorderThickness="0"
                                Cursor="Hand">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        CornerRadius="4"
                                                        Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#D0D0D0"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        
                        <Button Content="Salva"
                                Command="{Binding SaveMedicationAsyncCommand}"
                                Background="#0078D4"
                                Foreground="White"
                                Padding="20,10"
                                BorderThickness="0"
                                Cursor="Hand">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        CornerRadius="4"
                                                        Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#106EBE"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
