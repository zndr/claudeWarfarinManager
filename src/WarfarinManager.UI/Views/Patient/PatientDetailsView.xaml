<UserControl x:Class="WarfarinManager.UI.Views.Patient.PatientDetailsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:WarfarinManager.UI.ViewModels"
             xmlns:local="clr-namespace:WarfarinManager.UI.Views.Patient"
             xmlns:converters="clr-namespace:WarfarinManager.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1000"
             d:DataContext="{d:DesignInstance Type=vm:PatientDetailsViewModel}">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header con info paziente -->
        <Border Grid.Row="0" 
                Background="#0078D4" 
                Padding="20,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Pulsante Indietro -->
                <Button Grid.Column="0"
                        Content="â—„ Torna alla Lista"
                        Command="{Binding GoBackCommand}"
                        Background="Transparent"
                        Foreground="White"
                        FontSize="13"
                        BorderThickness="0"
                        Padding="10,8"
                        Margin="0,0,20,0"
                        Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}"
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Center"
                                                            VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#005A9E"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!-- Info Paziente -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="{Binding Patient.FullName, Mode=OneWay}"
                               FontSize="20" 
                               FontWeight="SemiBold" 
                               Foreground="White"/>
                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                        <TextBlock Text="CF: " FontSize="12" Foreground="White" Opacity="0.9"/>
                        <TextBlock Text="{Binding Patient.FiscalCode, Mode=OneWay}" FontSize="12" Foreground="White" Opacity="0.9"/>
                        <TextBlock Text=" | EtÃ : " FontSize="12" Foreground="White" Opacity="0.9"/>
                        <TextBlock Text="{Binding Patient.Age, Mode=OneWay}" FontSize="12" Foreground="White" Opacity="0.9"/>
                        <TextBlock Text=" anni | Nato il: " FontSize="12" Foreground="White" Opacity="0.9"/>
                        <TextBlock Text="{Binding Patient.BirthDate, StringFormat=dd/MM/yyyy, Mode=OneWay}" FontSize="12" Foreground="White" Opacity="0.9"/>
                    </StackPanel>
                </StackPanel>

                <!-- Azioni -->
                <StackPanel Grid.Column="2" 
                            Orientation="Horizontal">

                    <!-- Pulsante Gestione INR -->
                    <Button Content="ðŸ“Š Gestione INR"
                            Command="{Binding OpenINRControlCommand}"
                            Background="#107C10"
                            Foreground="White"
                            FontSize="13"
                            FontWeight="SemiBold"
                            Padding="15,8"
                            Margin="0,0,10,0"
                            BorderThickness="0"
                            Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}"
                                                    CornerRadius="4"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#0E6B0E"/>
                                    </Trigger>
                                    <Trigger Property="IsPressed" Value="True">
                                        <Setter Property="Background" Value="#0C5A0C"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                    <!-- Pulsante Modifica Anagrafica -->
                    <Button Content="âœ Modifica Anagrafica"
                            Command="{Binding EditPatientCommand}"
                            Background="White"
                            Foreground="#0078D4"
                            FontSize="13"
                            FontWeight="SemiBold"
                            Padding="15,8"
                            BorderThickness="0"
                            Cursor="Hand">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}"
                                                    CornerRadius="4"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center"
                                                                VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#F0F0F0"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>

                </StackPanel>
            </Grid>
        </Border>

        <!-- TabControl con sezioni -->
        <TabControl Grid.Row="1" 
                    SelectedIndex="{Binding SelectedTabIndex}"
                    Padding="0"
                    BorderThickness="0">
            <TabControl.Resources>
                <Style TargetType="TabItem">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="TabItem">
                                <Border Name="Border" 
                                        Background="Transparent" 
                                        BorderThickness="0"
                                        Padding="20,12">
                                    <ContentPresenter ContentSource="Header"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Center"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Border" Property="Background" Value="White"/>
                                        <Setter TargetName="Border" Property="BorderThickness" Value="0,0,0,3"/>
                                        <Setter TargetName="Border" Property="BorderBrush" Value="#0078D4"/>
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Border" Property="Background" Value="#F5F5F5"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="FontSize" Value="14"/>
                    <Setter Property="FontWeight" Value="SemiBold"/>
                </Style>
            </TabControl.Resources>

            <!-- Tab 1: Anagrafica -->
            <TabItem Header="ðŸ“‹ Anagrafica">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="30">
                    <StackPanel MaxWidth="700">
                        <TextBlock Text="DATI PERSONALI" 
                                   FontSize="14" 
                                   FontWeight="SemiBold" 
                                   Foreground="#0078D4"
                                   Margin="0,0,0,15"/>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Nome:" FontWeight="SemiBold" Margin="0,8"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Patient.FirstName}" Margin="0,8"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Cognome:" FontWeight="SemiBold" Margin="0,8"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Patient.LastName}" Margin="0,8"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Codice Fiscale:" FontWeight="SemiBold" Margin="0,8"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Patient.FiscalCode}" Margin="0,8"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Sesso:" FontWeight="SemiBold" Margin="0,8"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding Patient.Gender}" Margin="0,8"/>

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Telefono:" FontWeight="SemiBold" Margin="0,8"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding Patient.Phone}" Margin="0,8"/>

                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Email:" FontWeight="SemiBold" Margin="0,8"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding Patient.Email}" Margin="0,8"/>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Tab 2: Indicazioni Terapeutiche -->
            <TabItem Header="ðŸŽ¯ Indicazioni Terapeutiche">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Toolbar -->
                    <Border Grid.Row="0" 
                            Background="#F5F5F5" 
                            Padding="20,15"
                            BorderBrush="#E0E0E0"
                            BorderThickness="0,0,0,1">
                        <StackPanel Orientation="Horizontal">
                            <Button Content="âž• Nuova Indicazione"
                                    Command="{Binding AddIndicationCommand}"
                                    Background="#107C10"
                                    Foreground="White"
                                    FontWeight="SemiBold"
                                    Padding="15,8"
                                    Margin="0,0,10,0"
                                    BorderThickness="0"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}"
                                                            CornerRadius="4"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#0F6B0D"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>

                            <Button Content="â¹ Termina Indicazione"
                                    Command="{Binding EndIndicationCommand}"
                                    Background="#D13438"
                                    Foreground="White"
                                    FontWeight="SemiBold"
                                    Padding="15,8"
                                    BorderThickness="0"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}"
                                                            CornerRadius="4"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#A72B2E"/>
                                            </Trigger>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Background" Value="#C0C0C0"/>
                                                <Setter Property="Cursor" Value="Arrow"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                    </Border>

                    <!-- Lista Indicazioni -->
                    <DataGrid Grid.Row="1"
                              ItemsSource="{Binding Indications}"
                              SelectedItem="{Binding SelectedIndication}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              SelectionMode="Single"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              RowHeight="50"
                              FontSize="13"
                              AlternatingRowBackground="#F9F9F9"
                              CanUserResizeRows="False"
                              CanUserSortColumns="True">

                        <DataGrid.ColumnHeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Background" Value="#E8E8E8"/>
                                <Setter Property="Foreground" Value="#333333"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="Padding" Value="12,10"/>
                                <Setter Property="BorderThickness" Value="0,0,1,1"/>
                                <Setter Property="BorderBrush" Value="#D0D0D0"/>
                                <Setter Property="HorizontalContentAlignment" Value="Left"/>
                            </Style>
                        </DataGrid.ColumnHeaderStyle>

                        <DataGrid.CellStyle>
                            <Style TargetType="DataGridCell">
                                <Setter Property="Padding" Value="12,0"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border Padding="{TemplateBinding Padding}"
                                                    Background="{TemplateBinding Background}">
                                                <ContentPresenter VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="#E3F2FD"/>
                                        <Setter Property="Foreground" Value="Black"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.CellStyle>

                        <DataGrid.Columns>
                            <!-- Stato -->
                            <DataGridTextColumn Header="Stato" 
                                                Binding="{Binding Status}"
                                                Width="100"/>

                            <!-- Categoria -->
                            <DataGridTextColumn Header="Categoria" 
                                                Binding="{Binding Category}"
                                                Width="200"/>

                            <!-- Descrizione -->
                            <DataGridTextColumn Header="Indicazione" 
                                                Binding="{Binding Description}"
                                                Width="*"/>

                            <!-- Target INR -->
                            <DataGridTextColumn Header="Target INR" 
                                                Binding="{Binding TargetINRRange}"
                                                Width="120"/>

                            <!-- Periodo -->
                            <DataGridTextColumn Header="Periodo" 
                                                Binding="{Binding Period}"
                                                Width="250"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Messaggio lista vuota -->
                    <StackPanel Grid.Row="1"
                               VerticalAlignment="Center"
                               HorizontalAlignment="Center"
                               Visibility="{Binding Indications.Count, Converter={StaticResource CountToVisibilityConverter}}">
                        <TextBlock Text="ðŸ“‹ Nessuna indicazione registrata"
                                   FontSize="16"
                                   Foreground="#A0A0A0"
                                   HorizontalAlignment="Center"
                                   Margin="0,0,0,10"/>
                        <TextBlock Text="Clicca su 'Nuova Indicazione' per aggiungerne una"
                                   FontSize="13"
                                   Foreground="#A0A0A0"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- Tab 3: Farmaci -->
            <TabItem Header="ðŸ’Š Farmaci">
                <local:MedicationsView DataContext="{Binding MedicationsViewModel}"/>
            </TabItem>

            <!-- Tab 4: Storico INR (placeholder) -->
            <TabItem Header="ðŸ“Š Storico INR">
                <Grid>
                    <TextBlock Text="Storico controlli INR - In sviluppo"
                               FontSize="16"
                               Foreground="#A0A0A0"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                </Grid>
            </TabItem>

            <!-- Tab 5: Eventi Avversi (placeholder) -->
            <TabItem Header="âš  Eventi Avversi">
                <Grid>
                    <TextBlock Text="Gestione eventi avversi - In sviluppo"
                               FontSize="16"
                               Foreground="#A0A0A0"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="2" 
              Background="#80FFFFFF"
              Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="â³ Caricamento dati paziente..."
                           FontSize="16"
                           FontWeight="SemiBold"
                           Foreground="#0078D4"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
